<!--
SPDX-FileCopyrightText: 2021 smdn <smdn@smdn.jp>
SPDX-License-Identifier: MIT
-->
<Project>
  <!--
    _NETSdkAvailableApi
      description:
        This item defines the target for generating symbols for the API and the framework version in which the API is supported.
        Symbols will be generated based on the attribute values of Namespace and Include.
        example:
          @Namespace="System", @Include="Array.Empty" -> "SYSTEM_ARRAY_EMPTY"
          @Namespace="System", @Include="Enum.IsDefined&lt;TEnum&gt;" -> "SYSTEM_ENUM_ISDEFINED_OF_TENUM"
          @Namespace="System.Text.Unicode", @Include="%2A" -> "SYSTEM_TEXT_UNICODE"
      attributes:
        TargetFrameworkCondition:
          description:
            The target framework version where the API support have been available.
            ref: list of preprocessor symbols for .NET target frameworks: https://docs.microsoft.com/ja-jp/dotnet/standard/frameworks
          example:
            "NETFRAMEWORK"
            "NETSTANDARD2_1_OR_GREATER;NETCOREAPP2_1_OR_GREATER;NET5_0_OR_GREATER"
        Namespace:
          description: The namespace of the API.
          example: "System", "System.Buffers"
        Include:
          description:
            The name of type or member of the API.
            The character '*' represents the entire namespace.
          example:
            "IAsyncDisposable"
            "Array.Empty"
            "Exception.ctor(SerializationInfo)"
            "CryptoStream.ctor(leaveOpen)"
            "Enum.IsDefined&lt;TEnum&gt;"
            "Int32.Parse(ReadOnlySpan&lt;Char&gt;)"
            "%2A" (entire namespace)

    _NETSdkAvailableApi (API group)
      description:
        This item defines the target for generating symbols for the API group and the framework version in which the API is supported.
        Symbols will be generated from the attribute value of Include.
      attributes:
        TargetFrameworkCondition:
          description:
            Same as _NETSdkAvailableApi.
        Include:
          description:
            The name of the API group.
          example:
            "GENERIC_MATH_INTERFACES"
  -->
  <Target
    Name="ListNETSdkAvailableApiName"
    Returns="@(NETSdkAvailableApiSymbol)"
  >
    <ItemGroup>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netfx.proj" TargetFrameworkCondition="NETFRAMEWORK"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.0+netcoreapp1.0+netfx.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_0_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NETFRAMEWORK"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.1+netcoreapp1.0+net45.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_1_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NET45_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.3+netcoreapp1.0+netfx.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_3_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NETFRAMEWORK"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.3+netcoreapp1.0+net46.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_3_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NET46_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.5+netcoreapp1.0+netfx.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_5_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NETFRAMEWORK"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.5+netcoreapp1.0+net461.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_5_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NET461_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.6+netcoreapp1.0+net47.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_6_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NET47_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard1.6+netcoreapp1.0+net471.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD1_6_OR_GREATER;NETCOREAPP1_0_OR_GREATER;NET471_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.0+netcoreapp2.0.proj"         TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_0_OR_GREATER;NETCOREAPP2_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.0+netcoreapp2.0+netfx.proj"   TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_0_OR_GREATER;NETCOREAPP2_0_OR_GREATER;NETFRAMEWORK"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.0+netcoreapp2.0+net461.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_0_OR_GREATER;NETCOREAPP2_0_OR_GREATER;NET461_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.1+netcoreapp2.0.proj"         TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_1_OR_GREATER;NETCOREAPP2_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.1+netcoreapp2.0+net472.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_1_OR_GREATER;NETCOREAPP2_0_OR_GREATER;NET472_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.1+netcoreapp2.1.proj"         TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_1_OR_GREATER;NETCOREAPP2_1_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netstandard2.1+netcoreapp3.0.proj"         TargetFrameworkCondition="NET5_0_OR_GREATER;NETSTANDARD2_1_OR_GREATER;NETCOREAPP3_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netcoreapp2.1.proj"        TargetFrameworkCondition="NET5_0_OR_GREATER;NETCOREAPP2_1_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netcoreapp3.0.proj"        TargetFrameworkCondition="NET5_0_OR_GREATER;NETCOREAPP3_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netcoreapp3.0+netfx.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER;NETCOREAPP3_0_OR_GREATER;NETFRAMEWORK"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\netcoreapp3.0+net48.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER;NETCOREAPP3_0_OR_GREATER;NET48_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\net5.0.proj"  TargetFrameworkCondition="NET5_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\net6.0.proj"  TargetFrameworkCondition="NET6_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\net7.0.proj"  TargetFrameworkCondition="NET7_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\net8.0.proj"  TargetFrameworkCondition="NET8_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\net9.0.proj"  TargetFrameworkCondition="NET9_0_OR_GREATER"/>
      <_AvailableApiListFile Include="$(MSBuildThisFileDirectory)available-apis\net10.0.proj" TargetFrameworkCondition="NET10_0_OR_GREATER"/>
    </ItemGroup>

    <!-- import available API lists -->
    <MSBuild
      Projects="$(MSBuildThisFileFullPath)"
      Targets="_ImportNETSdkAvailableApis"
      Properties="DefineConstants=$(DefineConstants);ImportFile=%(_AvailableApiListFile.Identity);TargetFrameworkCondition=%(_AvailableApiListFile.TargetFrameworkCondition)"
    >
      <Output TaskParameter="TargetOutputs" ItemName="_NETSdkAvailableApi" />
    </MSBuild>

    <!-- generate symbols -->
    <ItemGroup>
      <_NETSdkAvailableApiGroup Include="@(_NETSdkAvailableApi->HasMetadata('TargetApiFullName'))" />
      <_NETSdkAvailableApi Remove="@(_NETSdkAvailableApi->HasMetadata('TargetApiFullName'))" />
    </ItemGroup>

    <ItemGroup>
      <_NETSdkAvailableApiSymbol Include="@(_NETSdkAvailableApi)">
        <TargetApiFullName Condition="'%(Identity)' == '*'">%(Namespace)</TargetApiFullName>
        <TargetApiFullName Condition="'%(Identity)' != '*'">%(Namespace).%(Identity)</TargetApiFullName>
      </_NETSdkAvailableApiSymbol>

      <_NETSdkAvailableApiSymbol Update="@(_NETSdkAvailableApiSymbol)">
        <Constant>$(
          [System.Text.RegularExpressions.Regex]::Replace(
            $(
              [System.String]::new('%(TargetApiFullName)')
                .Replace('&lt;', '_OF_')
                .Replace('&gt;', '')
                .Replace(')', '')
            ),
            '[\.\,\(\+\:\`\s]',
            '_'
          )
          .ToUpperInvariant()
        )</Constant>
      </_NETSdkAvailableApiSymbol>
    </ItemGroup>

    <ItemGroup>
      <NETSdkAvailableApiSymbol
        Condition="0 &lt; @(_NETSdkAvailableApiSymbol->Count())"
        Include="@(_NETSdkAvailableApiSymbol->Metadata('Constant'))"
        TargetApiFullName="%(_NETSdkAvailableApiSymbol.TargetApiFullName)"
      />
      <NETSdkAvailableApiSymbol Include="@(_NETSdkAvailableApiGroup)" />
    </ItemGroup>
  </Target>

  <Target
    Name="_ImportNETSdkAvailableApis"
    Returns="@(_NETSdkAvailableApi)"
  >
    <MSBuild
      Properties="Set=$(DefineConstants);OtherSet=$(TargetFrameworkCondition)"
      Projects="$(MSBuildThisFileDirectory)TestSetOverlapsWith.targets"
      Targets="TestSetOverlapsWith"
    >
      <Output TaskParameter="TargetOutputs" PropertyName="_IsTargetFrameworkConditionMatched" />
    </MSBuild>

    <MSBuild
      Projects="$(ImportFile)"
      Targets="_ExportNETSdkAvailableApi"
      Condition="'$(_IsTargetFrameworkConditionMatched)' == 'true'"
    >
      <Output TaskParameter="TargetOutputs" ItemName="_NETSdkAvailableApi" />
    </MSBuild>

    <ItemGroup>
      <_NETSdkAvailableApi
        Update="@(_NETSdkAvailableApi)"
        TargetFrameworkCondition="$(TargetFrameworkCondition)"
        Condition="'$(_IsTargetFrameworkConditionMatched)' == 'true'"
      />
    </ItemGroup>
  </Target>
</Project>
