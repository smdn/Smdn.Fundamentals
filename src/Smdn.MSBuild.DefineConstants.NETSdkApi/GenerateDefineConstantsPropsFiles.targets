<!--
SPDX-FileCopyrightText: 2026 smdn <smdn@smdn.jp>
SPDX-License-Identifier: MIT
-->
<Project>
  <Target
    Name="GenerateDefineConstantsPropsFiles"
    AfterTargets="Compile"
  >
    <PropertyGroup>
      <_DefineConstantsPropsFileOutputDirectory>$(MSBuildProjectDirectory)\build\project\define-constants\</_DefineConstantsPropsFileOutputDirectory>
      <_DefineConstantsPropsCommonFileNamePrefix>DefineConstants.NETSdkApi</_DefineConstantsPropsCommonFileNamePrefix>
      <_DefineConstantsPropsImportFileOutputPath>$(_DefineConstantsPropsFileOutputDirectory)$(_DefineConstantsPropsCommonFileNamePrefix).props</_DefineConstantsPropsImportFileOutputPath>
    </PropertyGroup>

    <ItemGroup>
      <!-- .NET GA -->
      <_DefineConstantsPropsTargetFramework Include="net10.0;net9.0;net8.0" />

      <!-- .NET Standard 2.x (recommended version) -->
      <_DefineConstantsPropsTargetFramework Include="netstandard2.1;netstandard2.0" />

      <!-- .NET Framework GA -->
      <_DefineConstantsPropsTargetFramework Include="net481;net48;net472;net471;net47;net462" />

      <!-- .NET EOL -->
      <_DefineConstantsPropsTargetFramework Include="net7.0;net6.0;net5.0" />

      <!-- .NET Standard 1.x (not recommended version) -->
      <_DefineConstantsPropsTargetFramework Include="netstandard1.6;netstandard1.5;netstandard1.4;netstandard1.3;netstandard1.2;netstandard1.1;netstandard1.0" />

      <!-- .NET Core EOL -->
      <_DefineConstantsPropsTargetFramework Include="netcoreapp3.1;netcoreapp3.0;netcoreapp2.1;netcoreapp2.0;netcoreapp1.1;netcoreapp1.0" />

      <!-- .NET Framework EOL -->
      <_DefineConstantsPropsTargetFramework Include="net461;net46;net452;net451;net45" />

      <_DefineConstantsPropsFiles Include="@(_DefineConstantsPropsTargetFramework)">
        <OutputFileName>$(_DefineConstantsPropsCommonFileNamePrefix).%(_DefineConstantsPropsTargetFramework.Identity).props</OutputFileName>
      </_DefineConstantsPropsFiles>
    </ItemGroup>

    <!--
      generates props files to import $(DefineConstants) for each $(TargetFramework)-s
    -->
    <MSBuild
      Projects="$(MSBuildProjectFile)"
      Targets="_GenerateDefineConstantsPropsFileForTargetFramework"
      Properties="
        TargetFramework=%(_DefineConstantsPropsFiles.Identity);
        _DefineConstantsPropsFileOutputPath=$(_DefineConstantsPropsFileOutputDirectory)%(_DefineConstantsPropsFiles.OutputFileName);
      "
    />

    <!--
      generates props file for selecting and importing props file for specific $(TargetFramework)
    -->
    <ItemGroup>
      <_DefineConstantsPropsImportLines Include="&lt;Import Condition=&quot;&apos;$([MSBuild]::Escape('$'))(TargetFramework)&apos;==&apos;%(_DefineConstantsPropsFiles.Identity)&apos;&quot; Project=&quot;$([MSBuild]::Escape('$'))(MSBuildThisFileDirectory)%(_DefineConstantsPropsFiles.OutputFileName)&quot;/&gt;" />
    </ItemGroup>

    <PropertyGroup>
      <_DefineConstantsPropsImportFileContent><![CDATA[<!--
SPDX-FileCopyrightText: 2026 smdn <smdn@smdn.jp>
SPDX-License-Identifier: MIT
-->
<!--
  DO NOT EDIT DIRECTLY!
  This file is automatically generated and updated by $(MSBuildThisFile).
-->
<Project>
  <ImportGroup Condition="'$([MSBuild]::Escape('$'))(TargetFramework)'!=''">
    @(_DefineConstantsPropsImportLines, '%0A    ')
  </ImportGroup>
</Project>
]]></_DefineConstantsPropsImportFileContent>
    </PropertyGroup>

    <!--
      Line breaks are canonicalized to <CRLF>.
      First, replace <CRLF> with <LF> and <CR> with <LF>. Then, replace <LF> back to <CRLF>.
    -->
    <WriteAllTextToFile
      Path="$(_DefineConstantsPropsImportFileOutputPath)"
      PrependBom="true"
      Content="$(_DefineConstantsPropsImportFileContent.Replace('%0D%0A', '%0A').Replace('%0D', '%0A').Replace('%0A', '%0D%0A'))"
    />

    <Message Importance="high" Text="Generated $(_DefineConstantsPropsImportFileOutputPath)" />
  </Target>

  <Target
    Name="_GenerateDefineConstantsPropsFileForTargetFramework"
    DependsOnTargets="AddImplicitDefineConstants"
  >
    <CallTarget Targets="ListNETSdkAvailableApiName">
      <Output TaskParameter="TargetOutputs" ItemName="_NETSdkAvailableApiSymbol" />
    </CallTarget>

    <PropertyGroup>
      <_NETSdkApiDefineConstantsPropsFileDefineConstants>@(_NETSdkAvailableApiSymbol, ';')</_NETSdkApiDefineConstantsPropsFileDefineConstants>
    </PropertyGroup>

    <Message Importance="low" Text="_NETSdkApiDefineConstantsPropsFileDefineConstants: $(_NETSdkApiDefineConstantsPropsFileDefineConstants)" />

    <ItemGroup>
      <_DefineConstantsPropertyLines Include="&lt;DefineConstants&gt;$([MSBuild]::Escape('$'))(DefineConstants)$([MSBuild]::Escape(';'))$([MSBuild]::Escape($(_NETSdkApiDefineConstantsPropsFileDefineConstants)))&lt;/DefineConstants&gt;" />
      <_DefineConstantsPropertyLines Include="&lt;!--" />
      <_DefineConstantsPropertyLines Include="#define %(_NETSdkAvailableApiSymbol.Identity) // %(_NETSdkAvailableApiSymbol.TargetApiFullName)" />
      <_DefineConstantsPropertyLines Include="--&gt;" />
    </ItemGroup>

    <Message Importance="low" Text="Generating: %(_DefineConstantsPropsFileLines.Identity)" />

    <PropertyGroup>
      <_DefineConstantsPropsFileContent><![CDATA[<!--
SPDX-FileCopyrightText: 2026 smdn <smdn@smdn.jp>
SPDX-License-Identifier: MIT
-->
<!--
  DO NOT EDIT DIRECTLY!
  This file is automatically generated and updated by $(MSBuildThisFile).
-->
<Project>
  <PropertyGroup>
    <!-- $([MSBuild]::Escape($(DefineConstants))) -->
    @(_DefineConstantsPropertyLines, '%0A    ')
  </PropertyGroup>
</Project>
]]></_DefineConstantsPropsFileContent>
    </PropertyGroup>

    <!--
      Line breaks are canonicalized to <CRLF>.
      First, replace <CRLF> with <LF> and <CR> with <LF>. Then, replace <LF> back to <CRLF>.
    -->
    <WriteAllTextToFile
      Path="$(_DefineConstantsPropsFileOutputPath)"
      PrependBom="true"
      Content="$(_DefineConstantsPropsFileContent.Replace('%0D%0A', '%0A').Replace('%0D', '%0A').Replace('%0A', '%0D%0A'))"
    />

    <Message Importance="high" Text="Generated $(_DefineConstantsPropsFileOutputPath)" />
  </Target>
</Project>
