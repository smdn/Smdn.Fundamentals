<!--
SPDX-FileCopyrightText: 2023 smdn <smdn@smdn.jp>
SPDX-License-Identifier: MIT
-->
<Project>
  <!--
    Set the value of metadata `ReferenceAssemblyVersion` in ProjectReference to the
    `AdditionalProperties` of inner builds, for overriding AssemblyVersion of ProjectReference
    with the specified value.

    In the referenced project, the specified assembly version will be passed by property
    `AssemblyVersionSpecifiedByProjectReference`.

    The properties set in AdditionalProperties become 'global properties' and are also
    transitively passed to the nested ProjectReference.

    To avoid transitive value passing, if `ReferenceAssemblyVersion` is not specified,
    set the empty value to `AssemblyVersionSpecifiedByProjectReference` explicitly.

    See also 'props/AssemblyAttributes.AssemblyVersion.props'.
  -->
  <Target
    Name="SetReferenceAssemblyVersionForProjectReference"
    BeforeTargets="BeforeResolveReferences"
  >
    <ItemGroup>
      <ProjectReference
        Update="%(ProjectReference.Identity)"
        AdditionalProperties="AssemblyVersionSpecifiedByProjectReference=;%(ProjectReference.AdditionalProperties)"
        Condition=" '%(ProjectReference.ReferenceAssemblyVersion)' == '' "
      />
      <ProjectReference
        Update="%(ProjectReference.Identity)"
        AdditionalProperties="AssemblyVersionSpecifiedByProjectReference=%(ProjectReference.ReferenceAssemblyVersion);%(ProjectReference.AdditionalProperties)"
        Condition=" '%(ProjectReference.ReferenceAssemblyVersion)' != '' "
      />
    </ItemGroup>
  </Target>
</Project>
